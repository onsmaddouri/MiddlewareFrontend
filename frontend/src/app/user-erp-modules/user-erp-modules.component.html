<div class="user-erp-modules">
  <div class="page-header">
    <h1><i class="bi bi-gear-fill"></i> Consultation des Modules ERP</h1>
    <p>Consulter les modules des systèmes ERP (lecture seule)</p>
  </div>

  <!-- Formulaire de recherche -->
  <div class="search-section">
    <form (ngSubmit)="onSearch()" class="search-form">
      <div class="form-row">
        <div class="form-group">
          <label>Nom</label>
          <input type="text" class="form-control" placeholder="Rechercher par nom..." [(ngModel)]="search.nom" name="nom">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select class="form-control" [(ngModel)]="search.typeModule" name="typeModule">
            <option value="">Tous les types</option>
            <option value="COMPETITION">COMPETITION</option>
            <option value="PRODUCT">PRODUCT</option>
            <option value="TRAINING">TRAINING</option>
            <option value="USER">USER</option>
            <option value="DATA">DATA</option>
          </select>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select class="form-control" [(ngModel)]="search.actif" name="actif">
            <option value="">Tous les statuts</option>
            <option value="true">Actif</option>
            <option value="false">Inactif</option>
          </select>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary" [disabled]="!atLeastOneFilled()">
            <i class="bi bi-search"></i> Rechercher
          </button>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-outline-secondary" (click)="resetSearch()">
            <i class="bi bi-arrow-clockwise"></i> Actualiser
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tableau des modules ERP -->
  <div class="table-section">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2">Chargement des modules ERP...</p>
    </div>
    
    <table *ngIf="!loading" class="table table-bordered table-striped table-hover">
      <thead class="thead-dark">
        <tr>
          <th>Nom</th>
          <th>Type</th>
          <th>Description</th>
          <th>ERP</th>
          <th>Statut</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let module of filteredModules; trackBy: trackByModuleId">
          <td>
            <strong>{{ module.nom }}</strong>
          </td>
          <td>
            <span class="badge badge-info">{{ module.typeModule }}</span>
          </td>
          <td>
            <span class="text-muted" *ngIf="!module.description">Aucune description</span>
            <span *ngIf="module.description">{{ module.description }}</span>
          </td>
          <td>
            <span class="badge badge-primary" *ngIf="module.erp">
              {{ module.erp.nom }}
            </span>
            <span class="text-muted" *ngIf="!module.erp">Non défini</span>
          </td>
          <td>
            <span class="badge" [ngClass]="module.actif ? 'badge-success' : 'badge-secondary'">
              {{ module.actif ? 'Actif' : 'Inactif' }}
            </span>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-info" 
                    (click)="showModuleDetails(module)"
                    title="Voir les détails">
              <i class="bi bi-eye"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Message si aucun module -->
    <div *ngIf="!loading && filteredModules.length === 0" class="alert alert-warning text-center">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Aucun module trouvé.
    </div>
  </div>
</div>

<!-- Modal de détails du module -->
<div class="modal fade" id="moduleDetailModal" tabindex="-1" aria-labelledby="moduleDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow rounded-4 border-0">
      <div class="modal-header" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff;">
        <h5 class="modal-title" id="moduleDetailModalLabel">
          <i class="bi bi-gear-fill me-2"></i>Détails du Module ERP - {{ selectedModule?.nom }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDetailModal()" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;" *ngIf="selectedModule">
        <div class="row">
          <div class="col-md-6">
            <div class="info-section">
              <h6><i class="bi bi-info-circle me-2"></i>Informations générales</h6>
              <table class="table table-borderless table-sm">
                <tr>
                  <td><strong>Nom :</strong></td>
                  <td>{{ selectedModule.nom }}</td>
                </tr>
                <tr>
                  <td><strong>Type :</strong></td>
                  <td><span class="badge badge-info">{{ selectedModule.typeModule }}</span></td>
                </tr>
                <tr>
                  <td><strong>ERP :</strong></td>
                  <td>
                    <span class="badge badge-primary" *ngIf="selectedModule.erp">
                      {{ selectedModule.erp.nom }}
                    </span>
                    <span class="text-muted" *ngIf="!selectedModule.erp">Non défini</span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Statut :</strong></td>
                  <td>
                    <span class="badge" [ngClass]="selectedModule.actif ? 'badge-success' : 'badge-secondary'">
                      {{ selectedModule.actif ? 'Actif' : 'Inactif' }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="selectedModule.description">
                  <td><strong>Description :</strong></td>
                  <td>{{ selectedModule.description }}</td>
                </tr>
              </table>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="config-section">
              <h6><i class="bi bi-gear-fill me-2"></i>Configurations</h6>
              
              <div *ngIf="selectedModule.schema" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Schéma :</strong>
                  <button class="btn btn-sm btn-outline-primary" (click)="showConfigDetail(selectedModule.schema)" title="Voir le schéma complet">
                    <i class="bi bi-eye"></i> Voir
                  </button>
                </div>
                <div class="config-preview">
                  <code>{{ getConfigPreview(selectedModule.schema) }}</code>
                </div>
              </div>
              
              <div *ngIf="selectedModule.endpoints" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Endpoints :</strong>
                  <button class="btn btn-sm btn-outline-primary" (click)="showConfigDetail(selectedModule.endpoints)" title="Voir les endpoints complets">
                    <i class="bi bi-eye"></i> Voir
                  </button>
                </div>
                <div class="config-preview">
                  <code>{{ getConfigPreview(selectedModule.endpoints) }}</code>
                </div>
              </div>
              
              <div *ngIf="selectedModule.configuration" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Configuration :</strong>
                  <button class="btn btn-sm btn-outline-primary" (click)="showConfigDetail(selectedModule.configuration)" title="Voir la configuration complète">
                    <i class="bi bi-eye"></i> Voir
                  </button>
                </div>
                <div class="config-preview">
                  <code>{{ getConfigPreview(selectedModule.configuration) }}</code>
                </div>
              </div>
              
              <div *ngIf="!selectedModule.schema && !selectedModule.endpoints && !selectedModule.configuration" class="text-muted">
                <i class="bi bi-info-circle me-2"></i>Aucune configuration disponible
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">
          <i class="bi bi-x-circle me-1"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour afficher la configuration complète -->
<div class="modal fade" id="configDetailModal" tabindex="-1" aria-labelledby="configDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow rounded-4 border-0">
      <div class="modal-header" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff;">
        <h5 class="modal-title" id="configDetailModalLabel">
          <i class="bi bi-gear-fill me-2"></i>Configuration du Module ERP
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeConfigModal()" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="config-detail-container">
          <pre class="config-json">{{ selectedConfig }}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfigModal()">
          <i class="bi bi-x-circle me-1"></i>Fermer
        </button>
        <button type="button" class="btn btn-primary" (click)="copyConfig()">
          <i class="bi bi-clipboard me-1"></i>Copier
        </button>
      </div>
    </div>
  </div>
</div>

