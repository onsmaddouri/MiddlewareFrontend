<div class="applications-open-source">
  <div class="page-header">
    <h1><i class="bi bi-app"></i> Applications Open Source</h1>
    <p>Gérer les applications open source disponibles</p>
  </div>

  <!-- Formulaire de recherche -->
  <div class="search-section">
    <form (ngSubmit)="onSearch()" #searchForm="ngForm" class="search-form">
      <div class="form-row">
        <div class="form-group">
          <label>Nom</label>
          <input type="text" class="form-control" placeholder="Nom" [(ngModel)]="search.nom" name="nom">
        </div>
        <div class="form-group">
          <label>Version</label>
          <input type="text" class="form-control" placeholder="Version" [(ngModel)]="search.version" name="version">
        </div>
        <div class="form-group">
          <label>Logo</label>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span *ngIf="search.logoUrl" class="d-flex align-items-center">
                <img [src]="search.logoUrl" alt="logo" style="height: 20px; width: 30px; object-fit: contain; margin-right: 8px;">
                <span class="logo-name">{{ getLogoName(search.logoUrl) }}</span>
              </span>
              <span *ngIf="!search.logoUrl">Sélectionner Logo</span>
            </button>
            <ul class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;">
              <li>
                <a class="dropdown-item" href="#" (click)="search.logoUrl = ''; onSearch(); $event.preventDefault();">
                  <span style="margin-left: 6px;">Aucun filtre</span>
                </a>
              </li>
              <li *ngFor="let url of logoUrls">
                <a class="dropdown-item d-flex align-items-center" href="#" (click)="search.logoUrl = url; onSearch(); $event.preventDefault();">
                  <img [src]="url" alt="logo" style="height: 20px; width: 30px; object-fit: contain; margin-right: 8px;">
                  <span class="logo-name">{{ getLogoName(url) }}</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary icon-button" [disabled]="!atLeastOneFilled()" title="Rechercher">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-outline-secondary icon-button" (click)="resetFilters()" title="Actualiser">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tableau des applications -->
  <div class="table-section">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2">Chargement des applications...</p>
    </div>
    
    <div class="table-responsive" *ngIf="!loading">
      <table class="table table-bordered table-striped table-hover text-center">
    <thead class="thead-light">
      <tr>
        <th>Nom</th>
        <th>Description</th>
        <th>Version</th>
        <th>Logo</th>
        <th class="text-center align-middle" style="vertical-align: middle;">
          <div class="d-flex justify-content-start align-items-center gap-2">
            <button class="btn btn-outline-success btn-lg"
                    style="width: 50px; height: 50px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                    (click)="openAddModal()"
                    title="Ajouter application">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let app of filteredApplications" class="table-row">
        <td>
          <ng-container *ngIf="editingId === app.id; else nomDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedApplication.nom">
          </ng-container>
          <ng-template #nomDisplay>{{ app.nom }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === app.id; else descDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedApplication.description">
          </ng-container>
          <ng-template #descDisplay>{{ app.description }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === app.id; else versionDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedApplication.version">
          </ng-container>
          <ng-template #versionDisplay>{{ app.version }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === app.id; else logoDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedApplication.logoUrl">
          </ng-container>
          <ng-template #logoDisplay>
            <img *ngIf="app.logoUrl" [src]="app.logoUrl" alt="logo" style="max-height: 40px; max-width: 80px; object-fit: contain;" />
          </ng-template>
        </td>
        <td class="d-flex justify-content-start align-items-center gap-2">
          <!-- Bouton Enregistrer : visible uniquement en édition -->
          <button *ngIf="editingId === app.id"
                  class="btn btn-outline-success"
                  title="Enregistrer"
                  (click)="saveEdit()">
            <i class="bi bi-save"></i>
          </button>

          <!-- Bouton Modifier : visible uniquement hors édition -->
          <button *ngIf="editingId !== app.id"
                  class="btn btn-outline-primary"
                  title="Modifier"
                  (click)="startEditing(app)">
            <i class="bi bi-pencil"></i>
          </button>

          <!-- Bouton Supprimer : toujours visible -->
          <button class="btn btn-outline-danger"
                  title="Supprimer"
                  (click)="openDeleteModal(app)">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    </tbody>
      </table>
    </div>

    <!-- Message si aucune application -->
    <div *ngIf="!loading && filteredApplications.length === 0" class="alert alert-warning text-center">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Aucune application trouvée.
    </div>
  </div>
</div>

<!-- Modal de confirmation suppression -->
<div class="modal fade" id="deleteAppModal" tabindex="-1" aria-labelledby="deleteAppModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 340px;">
    <div class="modal-content shadow rounded-4 border-0" style="background: #fff;">
      <div class="modal-header py-2" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <i class="bi bi-exclamation-circle-fill fs-4 me-2"></i>
        <h6 class="modal-title fw-bold" id="deleteAppModalLabel">Voulez-vous supprimer l'application&nbsp;?</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-2 fs-6" style="color: #046aa1;">
          L'application <span class="fw-bold">{{ applicationToDelete?.nom }}</span> sera supprimée.
        </div>
      </div>
      <div class="modal-footer justify-content-center gap-3 border-0 pb-3">
        <button type="button" class="btn btn-outline-primary rounded-pill px-3" style="min-width: 60px;" (click)="cancelDelete()">Non</button>
        <button type="button" class="btn btn-primary rounded-pill px-3" style="min-width: 60px;" (click)="confirmDelete()">Oui</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'ajout d'application -->
<div class="modal fade" id="addAppModal" tabindex="-1" aria-labelledby="addAppModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" (ngSubmit)="submitAddApplication()" #addAppForm="ngForm">
      <div class="modal-header" style="background: linear-gradient(to bottom, #204d74 0%, #4a77a8 100%); color: #fff;">
        <h5 class="modal-title" id="addAppModalLabel">Ajouter une application</h5>
        <button type="button"
                class="btn-close btn-close-white"
                aria-label="Fermer"
                (click)="cancelAddAppModal()">
        </button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Nom</label>
          <input type="text" class="form-control" [(ngModel)]="newApplication.nom" name="nom" required>
        </div>
        <div class="mb-2">
          <label>Description</label>
          <input type="text" class="form-control" [(ngModel)]="newApplication.description" name="description" required>
        </div>
        <div class="mb-2">
          <label>Version</label>
          <input type="text" class="form-control" [(ngModel)]="newApplication.version" name="version" required>
        </div>
        <div class="mb-2">
          <label>Logo URL</label>
          <input type="text" class="form-control" [(ngModel)]="newApplication.logoUrl" name="logoUrl" required>
        </div>
      </div>
      <div class="modal-footer flex-column">
        <button type="submit"
                class="btn w-100 mb-2"
                style="background: linear-gradient(to bottom, #204d74 0%, #4a77a8 100%); color: #fff; border: none;">
          Ajouter
        </button>
        <button type="button"
                class="btn w-100"
                (click)="cancelAddAppModal()"
                style="background: #eaf0fa; color: #204d74; border: none;">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>
