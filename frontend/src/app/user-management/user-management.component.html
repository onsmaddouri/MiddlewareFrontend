<div class="user-management">
  <div class="page-header">
    <h1><i class="bi bi-people-fill"></i> Gestion des Utilisateurs</h1>
    <p>Gérer les droits et permissions des utilisateurs</p>
  </div>

  <!-- Formulaire de recherche -->
  <div class="search-section">
    <form (ngSubmit)="onSearch()" class="search-form">
      <div class="form-row">
        <div class="form-group">
          <label>Nom d'utilisateur</label>
          <input type="text" class="form-control" [(ngModel)]="search.username" name="username" placeholder="Rechercher par nom...">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" [(ngModel)]="search.email" name="email" placeholder="Rechercher par email...">
        </div>
        <div class="form-group">
          <label>Rôle</label>
          <select class="form-control" [(ngModel)]="search.role" name="role">
            <option value="">Tous les rôles</option>
            <option value="ROLE_ADMIN">Administrateur</option>
            <option value="ROLE_USER">Utilisateur</option>
          </select>
        </div>
            <div class="form-group">
              <button type="submit" class="btn btn-primary" [disabled]="!atLeastOneFilled()">
                <i class="bi bi-search"></i> Rechercher
              </button>
            </div>
            <div class="form-group">
              <button type="button" class="btn btn-outline-secondary" (click)="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> Actualiser
              </button>
            </div>
      </div>
    </form>
  </div>

  <!-- Tableau des utilisateurs -->
  <div class="table-section">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2">Chargement des utilisateurs...</p>
    </div>
    
    <table *ngIf="!loading" class="table table-bordered table-striped table-hover">
      <thead class="thead-dark">
        <tr>
          <th>ID</th>
          <th>Nom d'utilisateur</th>
          <th>Email</th>
          <th>Rôle Actuel</th>
          <th class="text-center">
            <button class="btn btn-sm btn-outline-success" 
                    (click)="addUser()"
                    title="Ajouter un utilisateur">
              <i class="bi bi-plus"></i>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.id }}</td>
          <td>
            <input *ngIf="editingId === user.id" [(ngModel)]="user.username" class="form-control form-control-sm" />
            <span *ngIf="editingId !== user.id">{{ user.username }}</span>
          </td>
          <td>
            <input *ngIf="editingId === user.id" [(ngModel)]="user.email" class="form-control form-control-sm" />
            <span *ngIf="editingId !== user.id">{{ user.email }}</span>
          </td>
          <td>
            <span *ngIf="editingId !== user.id" class="badge" [ngClass]="getUserRole(user) === 'ROLE_ADMIN' ? 'badge-danger' : 'badge-primary'">
              {{ getUserRole(user) === 'ROLE_ADMIN' ? 'Administrateur' : 'Utilisateur' }}
            </span>
            <select *ngIf="editingId === user.id" [(ngModel)]="user.roles[0].name" class="form-control form-control-sm">
              <option value="ROLE_USER">Utilisateur</option>
              <option value="ROLE_ADMIN">Administrateur</option>
            </select>
          </td>
          <td>
            <div class="d-flex justify-content-center gap-2">
              <!-- Modifier -->
              <button *ngIf="editingId !== user.id"
                      (click)="startEditing(user.id)"
                      class="btn btn-sm btn-outline-primary"
                      title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              
              <!-- Enregistrer -->
              <button *ngIf="editingId === user.id"
                      (click)="saveChanges(user)"
                      class="btn btn-sm btn-outline-success"
                      title="Enregistrer">
                <i class="bi bi-save"></i>
              </button>
              
              <!-- Supprimer -->
              <button class="btn btn-sm btn-outline-danger"
                      title="Supprimer"
                      (click)="openDeleteModal(user)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Message si aucun utilisateur -->
    <div *ngIf="!loading && filteredUsers.length === 0" class="alert alert-warning text-center">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Aucun utilisateur trouvé.
    </div>
  </div>
</div>

<!-- Modal d'ajout d'utilisateur -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">
          <i class="bi bi-person-plus me-2"></i>Ajouter un utilisateur
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="addUsername" class="form-label">Nom d'utilisateur</label>
            <input type="text" class="form-control" id="addUsername" [(ngModel)]="newUser.username" name="username" required>
          </div>
          <div class="mb-3">
            <label for="addEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="addEmail" [(ngModel)]="newUser.email" name="email" required>
          </div>
          <div class="mb-3">
            <label for="addPassword" class="form-label">Mot de passe</label>
            <input type="password" class="form-control" id="addPassword" [(ngModel)]="newUser.password" name="password" required>
          </div>
          <div class="mb-3">
            <label for="addRole" class="form-label">Rôle</label>
            <select class="form-select" id="addRole" [(ngModel)]="newUserRole" name="role">
              <option value="ROLE_USER">Utilisateur</option>
              <option value="ROLE_ADMIN">Administrateur</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
          <i class="bi bi-x-circle me-1"></i>Annuler
        </button>
        <button type="button" class="btn btn-success" (click)="saveNewUser()">
          <i class="bi bi-check-circle me-1"></i>Ajouter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de suppression d'utilisateur -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 340px;">
    <div class="modal-content shadow rounded-4 border-0" style="background: #fff;">
      <div class="modal-header py-2" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <i class="bi bi-exclamation-circle-fill fs-4 me-2"></i>
        <h6 class="modal-title fw-bold" id="deleteUserModalLabel">Voulez-vous supprimer l'utilisateur ?</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-2 fs-6" style="color: #046aa1;">
          L'utilisateur <span class="fw-bold">{{ userToDelete?.username }}</span> sera supprimé.
        </div>
      </div>
      <div class="modal-footer justify-content-center gap-3 border-0 pb-3">
        <button type="button" class="btn btn-outline-primary rounded-pill px-3" style="min-width: 60px;" (click)="cancelDelete()">Non</button>
        <button type="button" class="btn btn-primary rounded-pill px-3" style="min-width: 60px;" (click)="confirmDelete()">Oui</button>
      </div>
    </div>
  </div>
</div>