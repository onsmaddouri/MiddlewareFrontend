<div class="connecteurs-management">
  <div class="page-header">
    <h1><i class="bi bi-plug"></i> Gestion des Connecteurs</h1>
    <p>Gérer les connecteurs de données</p>
  </div>

  <!-- Formulaire de recherche -->
  <div class="search-section">
    <form (ngSubmit)="onSearch()" #searchForm="ngForm" class="search-form">
      <div class="form-row">
        <div class="form-group">
          <label>Nom</label>
          <input type="text" class="form-control" placeholder="Nom" [(ngModel)]="search.nom" name="nom">
        </div>
        <div class="form-group">
          <label>Type</label>
          <input type="text" class="form-control" placeholder="Type" [(ngModel)]="search.type" name="type">
        </div>
        <div class="form-group">
          <label>Statut</label>
          <input type="text" class="form-control" placeholder="Statut" [(ngModel)]="search.statut" name="statut">
        </div>
        <div class="form-group">
          <label>Application</label>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ search.applicationOpenSource || 'Application Open Source' }}
            </button>
            <ul class="dropdown-menu w-100">
              <li>
                <a class="dropdown-item" href="#" (click)="search.applicationOpenSource = ''; onSearch(); $event.preventDefault();">
                  Aucun filtre
                </a>
              </li>
              <li *ngFor="let app of applications">
                <a class="dropdown-item" href="#" (click)="search.applicationOpenSource = app.nom; onSearch(); $event.preventDefault();">
                  {{ app.nom }}
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <label>ERP</label>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              {{ search.erp || 'ERP' }}
            </button>
            <ul class="dropdown-menu w-100">
              <li>
                <a class="dropdown-item" href="#" (click)="search.erp = ''; onSearch(); $event.preventDefault();">Aucun filtre</a>
              </li>
              <li *ngFor="let erp of erps">
                <a class="dropdown-item" href="#" (click)="search.erp = erp.nom; onSearch(); $event.preventDefault();">{{ erp.nom }}</a>
              </li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary icon-button" [disabled]="!atLeastOneFilled()" title="Rechercher">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div class="form-group">
          <button type="button" class="btn btn-outline-secondary icon-button" (click)="resetFilters()" title="Actualiser">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tableau des connecteurs -->
  <div class="table-section">
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Chargement...</span>
      </div>
      <p class="mt-2">Chargement des connecteurs...</p>
    </div>
    
    <div class="table-responsive" *ngIf="!loading">
      <table class="table table-bordered table-striped table-hover text-center">
    <thead class="thead-light">
      <tr>
        <th style="width: 15%;">Nom</th>
        <th style="width: 10%;">Type</th>
        <th style="width: 20%;">Configuration</th>
        <th style="width: 8%;">Statut</th>
        <th style="width: 15%;">Application Open Source</th>
        <th style="width: 10%;">ERP</th>
        <th style="width: 12%;" class="text-center align-middle" style="vertical-align: middle;">
          <div class="d-flex justify-content-start align-items-center gap-2">
            <button class="btn btn-outline-success btn-sm"
                    style="width: 40px; height: 40px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                    title="Ajouter connecteur"
                    (click)="openAddModal()">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let c of filteredConnecteurs" class="table-row">
        <td>
          <ng-container *ngIf="editingId === c.id; else nomDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedConnecteur.nom">
          </ng-container>
          <ng-template #nomDisplay>{{ c.nom }}</ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId === c.id; else typeDisplay">
            <input type="text" class="form-control" [(ngModel)]="editedConnecteur.type">
          </ng-container>
          <ng-template #typeDisplay>{{ c.type }}</ng-template>
        </td>
        <td style="max-width: 200px;">
          <ng-container *ngIf="editingId === c.id; else configDisplay">
            <div class="input-group">
              <textarea class="form-control" [(ngModel)]="editedConnecteur.configuration" rows="2"></textarea>
              <button type="button" class="btn btn-outline-info btn-sm" (click)="showEditConfigGuide()" title="Guide de configuration">
                <i class="bi bi-question-circle"></i>
              </button>
            </div>
          </ng-container>
          <ng-template #configDisplay>
            <div class="config-preview">
              <span class="config-text" [title]="c.configuration">
                {{ getConfigPreview(c.configuration) }}
              </span>
              <button class="btn btn-outline-info btn-sm ms-1" 
                      style="padding: 2px 6px; font-size: 0.75rem;"
                      title="Voir la configuration complète"
                      (click)="showConfigDetail(c.configuration)">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </ng-template>
        </td>
        <td>{{ c.statut }}</td>
        <td>{{ c.applicationOpenSource?.nom || 'N/A' }}</td>
        <td>{{ c.erp?.nom || 'N/A' }}</td>
        <td class="d-flex justify-content-start align-items-center gap-2">
          <button *ngIf="editingId === c.id"
                  class="btn btn-outline-success"
                  title="Enregistrer"
                  (click)="saveEdit()">
            <i class="bi bi-save"></i>
          </button>
          <button *ngIf="editingId !== c.id"
                  class="btn btn-outline-primary"
                  title="Modifier"
                  (click)="startEditing(c)">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-outline-danger"
                  title="Supprimer"
                  (click)="openDeleteModal(c)">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    </tbody>
      </table>
    </div>

    <!-- Message si aucun connecteur -->
    <div *ngIf="!loading && filteredConnecteurs.length === 0" class="alert alert-warning text-center">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Aucun connecteur trouvé.
    </div>
  </div>
</div>

<!-- Modal de confirmation suppression -->
<div class="modal fade" id="deleteConnecteurModal" tabindex="-1" aria-labelledby="deleteConnecteurModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 340px;">
    <div class="modal-content shadow rounded-4 border-0" style="background: #fff;">
      <div class="modal-header py-2" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
        <i class="bi bi-exclamation-circle-fill fs-4 me-2"></i>
        <h6 class="modal-title fw-bold" id="deleteConnecteurModalLabel">Voulez-vous supprimer le connecteur&nbsp;?</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer" (click)="cancelDelete()"></button>
      </div>
      <div class="modal-body text-center py-3">
        <div class="mb-2 fs-6" style="color: #046aa1;">
          Le connecteur <span class="fw-bold">{{ connecteurToDelete?.nom }}</span> sera supprimé.
        </div>
      </div>
      <div class="modal-footer justify-content-center gap-3 border-0 pb-3">
        <button type="button" class="btn btn-outline-primary rounded-pill px-3" style="min-width: 60px;" (click)="cancelDelete()">Non</button>
        <button type="button" class="btn btn-primary rounded-pill px-3" style="min-width: 60px;" (click)="confirmDelete()">Oui</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'ajout de connecteur -->
<div class="modal fade" id="addConnecteurModal" tabindex="-1" aria-labelledby="addConnecteurModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" (ngSubmit)="submitAddConnecteur()" #addConnecteurForm="ngForm">
      <div class="modal-header" style="background: linear-gradient(to bottom, #204d74 0%, #4a77a8 100%); color: #fff;">
        <h5 class="modal-title" id="addConnecteurModalLabel">Ajouter un connecteur</h5>
        <button type="button"
                class="btn-close btn-close-white"
                aria-label="Fermer"
                (click)="cancelAddConnecteurModal()">
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Informations de base -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Nom *</label>
            <input type="text" class="form-control" [(ngModel)]="newConnecteur.nom" name="nom" required placeholder="Ex: Dancescape API Connector">
          </div>
          <div class="col-md-6">
            <label>Type *</label>
            <select class="form-control" [(ngModel)]="newConnecteur.type" name="type" required (change)="onTypeChange()">
              <option value="">Sélectionner un type</option>
              <option value="REST_API">REST API</option>
              <option value="SOAP">SOAP</option>
              <option value="DATABASE">Database</option>
              <option value="FTP_SFTP">FTP/SFTP</option>
              <option value="ODOO">Odoo</option>
              <option value="ERPNEXT">ERPNext</option>
              <option value="SAP_RFC">SAP RFC</option>
            </select>
          </div>
        </div>

        <!-- URL et Protocole -->
        <div class="row mb-3">
          <div class="col-md-8">
            <label>URL Endpoint *</label>
            <input type="url" class="form-control" [(ngModel)]="newConnecteur.urlEndpoint" name="urlEndpoint" required placeholder="Ex: http://localhost:8081">
          </div>
          <div class="col-md-4">
            <label>Protocole</label>
            <select class="form-control" [(ngModel)]="newConnecteur.protocole" name="protocole">
              <option value="">Sélectionner</option>
              <option value="HTTP">HTTP</option>
              <option value="HTTPS">HTTPS</option>
              <option value="FTP">FTP</option>
              <option value="SFTP">SFTP</option>
            </select>
          </div>
        </div>

        <!-- Authentification -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Type d'authentification</label>
            <select class="form-control" [(ngModel)]="newConnecteur.authentification" name="authentification">
              <option value="">Aucune</option>
              <option value="Bearer">Bearer Token</option>
              <option value="Basic">Basic Auth</option>
              <option value="API_KEY">API Key</option>
              <option value="OAUTH">OAuth</option>
              <option value="JWT">JWT</option>
            </select>
          </div>
          <div class="col-md-6">
            <label>Credentials</label>
            <input type="password" class="form-control" [(ngModel)]="newConnecteur.credentials" name="credentials" placeholder="Token, clé API, etc.">
          </div>
        </div>

        <!-- Configuration avancée -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label>Timeout (ms)</label>
            <input type="number" class="form-control" [(ngModel)]="newConnecteur.timeout" name="timeout" min="1000" max="300000" placeholder="30000">
          </div>
          <div class="col-md-4">
            <label>Max Retries</label>
            <input type="number" class="form-control" [(ngModel)]="newConnecteur.maxRetries" name="maxRetries" min="0" max="10" placeholder="3">
          </div>
          <div class="col-md-4">
            <label>Version</label>
            <input type="text" class="form-control" [(ngModel)]="newConnecteur.versionConnecteur" name="versionConnecteur" placeholder="1.0">
          </div>
        </div>

        <!-- Configuration JSON -->
        <div class="mb-3">
          <label>Configuration JSON *</label>
          <div class="input-group">
            <textarea class="form-control" [(ngModel)]="newConnecteur.configuration" name="configuration" required rows="6" placeholder="Configuration JSON détaillée ou utilisez le guide"></textarea>
            <button type="button" class="btn btn-outline-info" (click)="showConfigGuide()" title="Guide de configuration">
              <i class="bi bi-question-circle"></i> Guide
            </button>
          </div>
          <small class="form-text text-muted">Configuration JSON complète ou utilisez le guide pour générer automatiquement</small>
        </div>

        <!-- Statut -->
        <div class="mb-3">
          <label>Statut</label>
          <select class="form-control" [(ngModel)]="newConnecteur.statut" name="statut">
            <option value="">Sélectionner un statut</option>
            <option value="ACTIF">Actif</option>
            <option value="INACTIF">Inactif</option>
            <option value="EN_TEST">En test</option>
            <option value="ERREUR">Erreur</option>
          </select>
        </div>

        <!-- Association -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label>Application Open Source</label>
            <select class="form-control" [(ngModel)]="newConnecteur.applicationOpenSource" name="applicationOpenSource">
              <option value="">Aucune</option>
              <option *ngFor="let app of applications" [ngValue]="app">{{ app.nom }}</option>
            </select>
          </div>
          <div class="col-md-6">
            <label>ERP</label>
            <select class="form-control" [(ngModel)]="newConnecteur.erp" name="erp">
              <option value="">Aucun</option>
              <option *ngFor="let erp of erps" [ngValue]="erp">{{ erp.nom }}</option>
            </select>
          </div>
        </div>

        <!-- Aide pour Dancescape -->
        <div class="alert alert-info" *ngIf="newConnecteur.type === 'REST_API'">
          <h6><i class="bi bi-info-circle me-2"></i>Configuration pour Dancescape</h6>
          <p class="mb-1">Pour connecter Dancescape :</p>
          <ul class="mb-0">
            <li><strong>URL:</strong> http://localhost:8081 (port différent du middleware)</li>
            <li><strong>Auth:</strong> Bearer Token (JWT)</li>
            <li><strong>Credentials:</strong> Token JWT obtenu via /auth/login</li>
            <li><strong>ERP:</strong> Sélectionner "Dancescape ERP"</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer flex-column">
        <button type="submit"
                class="btn w-100 mb-2"
                style="background: linear-gradient(to bottom, #204d74 0%, #4a77a8 100%); color: #fff; border: none;">
          Ajouter
        </button>
        <button type="button"
                class="btn w-100"
                (click)="cancelAddConnecteurModal()"
                style="background: #eaf0fa; color: #204d74; border: none;">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal pour afficher la configuration complète -->
<div class="modal fade" id="configDetailModal" tabindex="-1" aria-labelledby="configDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow rounded-4 border-0">
      <div class="modal-header" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff;">
        <h5 class="modal-title" id="configDetailModalLabel">
          <i class="bi bi-gear-fill me-2"></i>Configuration du Connecteur
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeConfigModal()" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="config-detail-container">
          <pre class="config-json">{{ selectedConfig }}</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfigModal()">
          <i class="bi bi-x-circle me-1"></i>Fermer
        </button>
        <button type="button" class="btn btn-primary" (click)="copyConfig()">
          <i class="bi bi-clipboard me-1"></i>Copier
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Guide de Configuration -->
<div class="modal fade" id="configGuideModal" tabindex="-1" aria-labelledby="configGuideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow rounded-4 border-0">
      <div class="modal-header" style="background: linear-gradient(135deg, #046aa1 0%, #003366 100%); color: #fff;">
        <h5 class="modal-title" id="configGuideModalLabel">
          <i class="bi bi-gear-fill me-2"></i>Guide de Configuration - {{ selectedConnectorType }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="configGuideModal.hide()" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div id="guideContent">
          <!-- Le contenu sera généré dynamiquement par JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="applyTemplate()">
          <i class="bi bi-clipboard me-1"></i>Appliquer le Template
        </button>
        <button type="button" class="btn btn-secondary" (click)="configGuideModal.hide()">
          <i class="bi bi-x-circle me-1"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div> 